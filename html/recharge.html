<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>会员充值</title>
    <link rel="stylesheet" href="../css/weui-min.css" />
    <link rel="stylesheet" href="../css/example.css" />
    <link rel="stylesheet" type="text/css" href="../css/overlay.css">
    <link rel="stylesheet" href="../css/global.css" />

    <!--<link rel="stylesheet" type="text/css" href="../vendor/iview/dist/styles/iview.css">-->
    <!--<link rel="stylesheet" type="text/css" href="../css/iview.css">-->

    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            background-color: white;
        }

        .row {
            display: flex;
            width: 50%;
            float: left;
        }

        .box {
            flex: 0 0 48%;
            margin: 1%;
            height: 100px;
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            display: flex;
            position: relative;
            border: 1px #1aad19 solid;
            color: #1aad19;
        }

        .choosen-box {
            flex: 0 0 48%;
            margin: 1%;
            height: 100px;
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            display: flex;
            position: relative;
            color: #00e4e6;
            border: 1px #00e4e6 solid
        }

        #box {
            flex: 0 0 48%;
            margin: 1%;
            height: 100px;
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            display: flex;
            position: relative;
            border: 1px #1aad19 solid;
            color: #1aad19;
        }

        #choosen-box {
            flex: 0 0 48%;
            margin: 1%;
            height: 100px;
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            display: flex;
            position: relative;
            color: #00e4e6;
            border: 1px #00e4e6 solid
        }

        .weui-picker__indicator {
            background-color: transparent;
        }

        .ivu-select-selection {
            border: none;
            outline: none;
        }

        .ivu-select-selection {
            outline: none;
            border: none;
        }

        .ivu-select .ivu-icon,
        .ivu-icon-ios-arrow-down,
        .ivu-select-arrow:before {
            display: none;
        }

        .ivu-select .ivu-icon .ivu-select-arrow:before {
            content: none;
        }

        @media only screen and (max-width: 768px) {
            .row {
                width: 100%
            }

            .box {
                flex: 0 0 31%;
                height: 60px;
                border-radius: 3px;
                border: 1px #1aad19 solid;
                color: #1aad19;
            }

            .choosen-box {
                flex: 0 0 31%;
                height: 60px;
                border-radius: 3px;
                color: #00e4e6;
                border: 1px #00e4e6 solid
            }

            #box {
                flex: 0 0 31%;
                height: 60px;
                border-radius: 3px;
                border: 1px #1aad19 solid;
                color: #1aad19;
            }

            #choosen-box {
                flex: 0 0 31%;
                height: 60px;
                border-radius: 3px;
                color: #00e4e6;
                border: 1px #00e4e6 solid
            }
        }
    </style>
</head>

<body>
    <div id='app' style="width:100%;height:100%">
        <div style="margin-top:-5px;text-align: center;padding-top:32px;padding-bottom:10px;line-height: 1.6;background-image: url(../src/background.png);background-repeat: no-repeat">
            <!--<h1 style="font-size: 1.6em;margin: 5px" v-text="name"></h1>-->
            <h2 style="font-size: 1.1em;background: transparent">本帐号余额</h2>
            <h1 style="font-size: 30px;color: #fe736c;background: transparent" v-text="'￥'+cash"></h1>
        </div>

        <a href="javascript:;" v-text="job_number==''?'请选择本次充值对应的技师':job_number" class="weui-btn weui-btn_default" @click="picker()" id="showPicker" style="margin-top: 5px;margin-bottom: 5px;color: #8c8ef9;"></a>
        <div>
            <div class="row">
                <div v-for="(val, index) in [100,200,500]" @click="choose(index)" :id="box_list[index]==0?'box':'choosen-box'">
                    <span style="margin-bottom: 10px;font-size:20px" v-text="'￥'+val"></span>
                    <span style="font-size: 10px;position: absolute;margin-top: 15px;" v-if="back_list[index]" v-text="'返还: ￥'+back_list[index]"></span>
                </div>
            </div>
            <div class="row">
                <div v-for="(val, index) in [1000,2000,5000]" @click="choose(index+3)" :id="box_list[index+3]==0?'box':'choosen-box'">
                    <span style="margin-bottom: 10px;font-size:20px" v-text="'￥'+val"></span>
                    <span style="font-size: 10px;position: absolute;margin-top: 15px;" v-if="back_list[index+3]" v-text="'返还: ￥'+back_list[index+3]"></span>
                </div>
            </div>
            <div class="row">
                <div v-for="(val, index) in [10000,20000,50000]" @click="choose(index+6)" :id="box_list[index+6]==0?'box':'choosen-box'">
                    <span style="margin-bottom: 10px;font-size:20px" v-text="'￥'+val"></span>
                    <span style="font-size: 10px;position: absolute;margin-top: 15px;" v-if="back_list[index+6]" v-text="'返还: ￥'+back_list[index+6]"></span>
                </div>
            </div>
        </div>


        <div class="weui-cells__title" v-on:click="userxuanzejine()" id="inputmoney">更多金额</div>
        <div class="weui-cells " v-if="xuanzejine">
            <div class="weui-cell weui-cell_swiped">
                <div class="weui-cell__bd">
                    <div class="weui-cell">
                        <input type="number" class="inputmoney" style="width: 94%;height: 38px;margin-left: 3%;outline: none;padding-left: 10px;border: 1px #e0ebeb solid"
                            v-model="fee" placeholder="手动输入充值金额">
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-cells__title">本次优惠</div>
        <div class="weui-cells">
            <div class="weui-cell weui-cell_swiped">
                <div class="weui-cell__bd" style="transform: translateX(-68px)">
                    <div class="weui-cell" onclick="navi('recharge.html')">
                        <div class="weui-cell__bd">
                            <p v-for="pro in promotion" style="margin-left: 20%">
                                <span style="display:inline-block ;width:40px">会员</span>
                                <span style="display:inline-block ;font-family: 华文雅黑;background-color: #fe736c;color: white;border-radius: 6px;padding: 0 2px;font-size: 15px">
                                    充返
                                </span>
                                <span style="display:inline-block;font-size: 13px;font-weight: 100;color: gray;" v-text="pro.content"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="position: fixed;bottom: 20px;width: 100%;height: 40px;">
            <button @click="recharge()" style="width: 94%;margin-left: 3%;height: 40px;border-radius: 15px;background-color: #00e4e6;border: none;color: white">
                确认充值
            </button>
        </div>
        <div id="modal-overlay" v-show="overlay">
            <div class="modal-data">
                <img src="../src/loading.gif" />
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../js/jweixin.js"></script>
<!-- <script type="text/javascript" src="../js/example.js"></script> -->
<script type="text/javascript" src="../js/weui-min.js"></script>
<script src="../js/vue.js"></script>
<script src="../js/url.js"></script>
<script type="text/javascript" src="../js/windowOpen.js"></script>

<!--<script type="text/javascript" src="../vendor/iview/dist/iview.min.js"></script>-->
<script type="text/javascript" src="../js/iview.min.js"></script>

<script>
    /**
     注意，大约在160行左右的post数据进行充值，user_id将在日后通过微信接口获得，目前只是静态数据，记得修改
     */
    let app = new Vue({
        el: "#app",
        data: {
            xuanzejine: false,
            jishi: [],
            model1: '',
            name: "",
            cash: 0,
            job_number: "",
            pay: 0,
            overlay: true,
            box_list: [
                0, 0, 0,
                0, 0, 0,
                0, 0, 0,
            ],
            fee_list: [
                100, 200, 500,
                1000, 2000, 5000,
                10000, 20000, 50000
            ],
            back_list: [],
            fee: 0,
            money: [],
            promotion: [],
        },
        methods: {
            judge_promotion(amount) {
                can_get = 0;
                for (var i = 0; i < this.promotion.length; i++) {
                    if (this.promotion[i].need <= amount) can_get = this.promotion[i].back;
                    else break;
                }
                return can_get == 0 ? false : can_get;
            },
            userxuanzejine() {
                this.xuanzejine = !this.xuanzejine;
                this.choose(-1);
            },
            //选择金额
            choose(idx) {
                var that = this;
                for (var i = 0; i < that.box_list.length; i++) {
                    if (i == idx) {

                        that.box_list[i] = 1;
                        that.fee = that.fee_list[i];
                    } else {
                        that.box_list[i] = 0;
                    }
                }
                //不能直接赋值，vue无法通过数组索引的方式检测到数据变化，必须用Vue.set来改变数据
                Vue.set(that.box_list, 0, that.box_list[0]);
            },
            picker() {
                var that = this;
                weui.picker(this.jishi, {
                    onChange: function (result) {
                        that.job_number = result[0]
                    },
                    onConfirm: function (result) {
                        that.job_number = result[0]
                    }
                });
            },
            recharge() {
                var that = this;

                if (this.job_number == "" || this.job_number == null) {
                    alert("请选择技师!");
                }
                if (this.fee == 0 || this.fee == '自定义') {
                    alert("请选择金额!");
                }
                if (this.job_number != "" && this.job_number != null && this.fee != 0 && this.fee != '') {

                    var url = encodeURIComponent(window.location.href + "?fee=" + that.fee + "&jbnb=" + that.job_number);
                    //金额单位以 分 表示
                    window.location.href = "http://1.jthysm.com/dashang/example/jsapiyy.php?pay=" + that.fee *
                        100 +
                        "&backurl=" + url
                }
            }
        },
        created() {
            var that = this
            var payret = getQueryString('payret');
            if (payret === "" || payret === undefined || payret == null) {
                //正常显示页面
                $.post("../php/getcustomer.php", {
                    phone: "13777579230"
                }).done((res) => {
                    res = JSON.parse(res);
                    if (res.status == 1) {
                        that.name = res.name;
                        that.cash = res.cash;
                        that.overlay = false;
                    }
                })
                $.post("../php/getpromotion.php", {
                    ajax_get: true
                }).done((res) => {
                    res = JSON.parse(res);
                    if (res.status == 1) {
                        that.promotion = res.data
                        for (var i in that.fee_list) {
                            that.back_list[i] = that.judge_promotion(that.fee_list[i]);
                        }
                    }
                })
                $.post("../php/getalltech.php").done((res) => {
                    res = JSON.parse(res);
                    that.jishi = res.data
                    for(i in this.jishi){
                        this.jishi[i] = {label:this.jishi[i]['job_number'],value:this.jishi[i]['job_number']};
                    }
                })

            } else if (payret === "1") //这里表示支付成功，返回该页面
            {
                that.overlay = true;

                $.post('../php/recharge.php', {
                    charge: getQueryString('fee'),
                    user_id: 1, //user_id为open_id
                    job_number: getQueryString('jbnb'),
                    pay: that.pay
                }).done((res) => {
                    res = JSON.parse(res);
                    if (res.status == 1) {
                        that.overlay = false;
                        $(that).openWindow("", "充值成功", ['好的'], () => {
                            window.location.href = "index.html";
                        }, () => {
                            window.location.href = "index.html";
                        })
                    }
                })
            } else if (payret === "2") {
                that.overlay = false;
                $(that).openWindow("", "充值失败", ['好的'], () => {
                    window.location.href = "recharge.html";
                });
            }
        },
    })
    $('.box').on('click', function () {
        $('div').siblings(".box").css({
            'color': '#1aad19',
            'border': '1px #1aad19 solid'
        });
        $(this).css({
            'color': '#00e4e6',
            'border': '1px #00e4e6 solid'
        });
    });
    $('#inputmoney').on('click', function () {
        $(".box").css({
            'color': '#1aad19',
            'border': '1px #1aad19 solid'
        });
    });
</script>

</html>